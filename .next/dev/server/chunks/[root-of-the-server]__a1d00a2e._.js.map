{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/LeadFlow/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // The \"setAll\" method was called from a Server Component.\n        }\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC5D;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/LeadFlow/lib/encryption.ts"],"sourcesContent":["import crypto from \"crypto\"\r\n\r\n// Master key must be a 32-byte key, provided as base64 in env CREDENTIALS_ENCRYPTION_KEY\r\nconst MASTER_KEY_ENV = process.env.CREDENTIALS_ENCRYPTION_KEY\r\n\r\nif (!MASTER_KEY_ENV) {\r\n  // We intentionally do not throw at import time to avoid breaking build if env is missing.\r\n  // The API routes that depend on this should validate and throw a clear error instead.\r\n  console.warn(\"CREDENTIALS_ENCRYPTION_KEY is not set. Encryption helpers will fail until it is configured.\")\r\n}\r\n\r\nfunction getMasterKey(): Buffer {\r\n  if (!MASTER_KEY_ENV) {\r\n    throw new Error(\"CREDENTIALS_ENCRYPTION_KEY is not configured\")\r\n  }\r\n  const key = Buffer.from(MASTER_KEY_ENV, \"base64\")\r\n  if (key.length !== 32) {\r\n    throw new Error(\"CREDENTIALS_ENCRYPTION_KEY must be a 32-byte key encoded in base64\")\r\n  }\r\n  return key\r\n}\r\n\r\nexport function generateRandomKey(): string {\r\n  // 32 random bytes, returned as base64\r\n  return crypto.randomBytes(32).toString(\"base64\")\r\n}\r\n\r\nexport interface EncryptedPayload {\r\n  ciphertext: string\r\n  iv: string\r\n  authTag: string\r\n}\r\n\r\nexport function encryptWithKey(keyBase64: string, plaintext: string): EncryptedPayload {\r\n  const key = Buffer.from(keyBase64, \"base64\")\r\n  if (key.length !== 32) {\r\n    throw new Error(\"Encryption key must be 32 bytes (base64-encoded)\")\r\n  }\r\n\r\n  const iv = crypto.randomBytes(12) // recommended IV size for GCM\r\n  const cipher = crypto.createCipheriv(\"aes-256-gcm\", key, iv)\r\n\r\n  const encrypted = Buffer.concat([cipher.update(plaintext, \"utf8\"), cipher.final()])\r\n  const authTag = cipher.getAuthTag()\r\n\r\n  return {\r\n    ciphertext: encrypted.toString(\"base64\"),\r\n    iv: iv.toString(\"base64\"),\r\n    authTag: authTag.toString(\"base64\"),\r\n  }\r\n}\r\n\r\nexport function decryptWithKey(keyBase64: string, payload: EncryptedPayload): string {\r\n  const key = Buffer.from(keyBase64, \"base64\")\r\n  if (key.length !== 32) {\r\n    throw new Error(\"Encryption key must be 32 bytes (base64-encoded)\")\r\n  }\r\n\r\n  const iv = Buffer.from(payload.iv, \"base64\")\r\n  const authTag = Buffer.from(payload.authTag, \"base64\")\r\n  const ciphertext = Buffer.from(payload.ciphertext, \"base64\")\r\n\r\n  const decipher = crypto.createDecipheriv(\"aes-256-gcm\", key, iv)\r\n  decipher.setAuthTag(authTag)\r\n\r\n  const decrypted = Buffer.concat([decipher.update(ciphertext), decipher.final()])\r\n  return decrypted.toString(\"utf8\")\r\n}\r\n\r\n// Wrap/unwrap per-user data key using master key\r\n\r\nexport function wrapUserKey(userKeyBase64: string): EncryptedPayload {\r\n  const masterKey = getMasterKey()\r\n  const iv = crypto.randomBytes(12)\r\n  const cipher = crypto.createCipheriv(\"aes-256-gcm\", masterKey, iv)\r\n\r\n  const encrypted = Buffer.concat([cipher.update(userKeyBase64, \"utf8\"), cipher.final()])\r\n  const authTag = cipher.getAuthTag()\r\n\r\n  return {\r\n    ciphertext: encrypted.toString(\"base64\"),\r\n    iv: iv.toString(\"base64\"),\r\n    authTag: authTag.toString(\"base64\"),\r\n  }\r\n}\r\n\r\nexport function unwrapUserKey(payload: EncryptedPayload): string {\r\n  const masterKey = getMasterKey()\r\n\r\n  const iv = Buffer.from(payload.iv, \"base64\")\r\n  const authTag = Buffer.from(payload.authTag, \"base64\")\r\n  const ciphertext = Buffer.from(payload.ciphertext, \"base64\")\r\n\r\n  const decipher = crypto.createDecipheriv(\"aes-256-gcm\", masterKey, iv)\r\n  decipher.setAuthTag(authTag)\r\n\r\n  const decrypted = Buffer.concat([decipher.update(ciphertext), decipher.final()])\r\n  return decrypted.toString(\"utf8\")\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;AAEA,yFAAyF;AACzF,MAAM,iBAAiB,QAAQ,GAAG,CAAC,0BAA0B;AAE7D,IAAI,CAAC,gBAAgB;IACnB,0FAA0F;IAC1F,sFAAsF;IACtF,QAAQ,IAAI,CAAC;AACf;AAEA,SAAS;IACP,IAAI,CAAC,gBAAgB;QACnB,MAAM,IAAI,MAAM;IAClB;IACA,MAAM,MAAM,OAAO,IAAI,CAAC,gBAAgB;IACxC,IAAI,IAAI,MAAM,KAAK,IAAI;QACrB,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEO,SAAS;IACd,sCAAsC;IACtC,OAAO,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;AACzC;AAQO,SAAS,eAAe,SAAiB,EAAE,SAAiB;IACjE,MAAM,MAAM,OAAO,IAAI,CAAC,WAAW;IACnC,IAAI,IAAI,MAAM,KAAK,IAAI;QACrB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC,IAAI,8BAA8B;;IAChE,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,eAAe,KAAK;IAEzD,MAAM,YAAY,OAAO,MAAM,CAAC;QAAC,OAAO,MAAM,CAAC,WAAW;QAAS,OAAO,KAAK;KAAG;IAClF,MAAM,UAAU,OAAO,UAAU;IAEjC,OAAO;QACL,YAAY,UAAU,QAAQ,CAAC;QAC/B,IAAI,GAAG,QAAQ,CAAC;QAChB,SAAS,QAAQ,QAAQ,CAAC;IAC5B;AACF;AAEO,SAAS,eAAe,SAAiB,EAAE,OAAyB;IACzE,MAAM,MAAM,OAAO,IAAI,CAAC,WAAW;IACnC,IAAI,IAAI,MAAM,KAAK,IAAI;QACrB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,KAAK,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE;IACnC,MAAM,UAAU,OAAO,IAAI,CAAC,QAAQ,OAAO,EAAE;IAC7C,MAAM,aAAa,OAAO,IAAI,CAAC,QAAQ,UAAU,EAAE;IAEnD,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,eAAe,KAAK;IAC7D,SAAS,UAAU,CAAC;IAEpB,MAAM,YAAY,OAAO,MAAM,CAAC;QAAC,SAAS,MAAM,CAAC;QAAa,SAAS,KAAK;KAAG;IAC/E,OAAO,UAAU,QAAQ,CAAC;AAC5B;AAIO,SAAS,YAAY,aAAqB;IAC/C,MAAM,YAAY;IAClB,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC;IAC9B,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,eAAe,WAAW;IAE/D,MAAM,YAAY,OAAO,MAAM,CAAC;QAAC,OAAO,MAAM,CAAC,eAAe;QAAS,OAAO,KAAK;KAAG;IACtF,MAAM,UAAU,OAAO,UAAU;IAEjC,OAAO;QACL,YAAY,UAAU,QAAQ,CAAC;QAC/B,IAAI,GAAG,QAAQ,CAAC;QAChB,SAAS,QAAQ,QAAQ,CAAC;IAC5B;AACF;AAEO,SAAS,cAAc,OAAyB;IACrD,MAAM,YAAY;IAElB,MAAM,KAAK,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE;IACnC,MAAM,UAAU,OAAO,IAAI,CAAC,QAAQ,OAAO,EAAE;IAC7C,MAAM,aAAa,OAAO,IAAI,CAAC,QAAQ,UAAU,EAAE;IAEnD,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,eAAe,WAAW;IACnE,SAAS,UAAU,CAAC;IAEpB,MAAM,YAAY,OAAO,MAAM,CAAC;QAAC,SAAS,MAAM,CAAC;QAAa,SAAS,KAAK;KAAG;IAC/E,OAAO,UAAU,QAAQ,CAAC;AAC5B"}},
    {"offset": {"line": 268, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/LeadFlow/app/api/integrations/test/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport nodemailer from \"nodemailer\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { decryptWithKey, unwrapUserKey } from \"@/lib/encryption\"\r\n\r\ninterface TestBody {\r\n  type: \"gmail\" | \"whatsapp\"\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = (await request.json()) as TestBody\r\n\r\n    if (!body?.type || (body.type !== \"gmail\" && body.type !== \"whatsapp\")) {\r\n      return NextResponse.json({ error: \"type must be 'gmail' or 'whatsapp'\" }, { status: 400 })\r\n    }\r\n\r\n    const supabase = await createClient()\r\n    const {\r\n      data: { user },\r\n    } = await supabase.auth.getUser()\r\n\r\n    if (!user) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n    }\r\n\r\n    const { data: integration, error } = await supabase\r\n      .from(\"user_integrations\")\r\n      .select(\"user_key_enc, gmail_address_enc, gmail_app_password_enc, ultramsg_instance_enc, ultramsg_token_enc\")\r\n      .eq(\"user_id\", user.id)\r\n      .single()\r\n\r\n    if (error || !integration) {\r\n      return NextResponse.json({ error: \"Integrations not configured\" }, { status: 400 })\r\n    }\r\n\r\n    const userKeyBase64 = unwrapUserKey(integration.user_key_enc)\r\n\r\n    if (body.type === \"gmail\") {\r\n      if (!integration.gmail_address_enc || !integration.gmail_app_password_enc) {\r\n        return NextResponse.json({ error: \"Gmail credentials not configured\" }, { status: 400 })\r\n      }\r\n\r\n      const gmailAddress = decryptWithKey(userKeyBase64, integration.gmail_address_enc)\r\n      const gmailAppPassword = decryptWithKey(userKeyBase64, integration.gmail_app_password_enc)\r\n\r\n      try {\r\n        const transporter = nodemailer.createTransport({\r\n          service: \"gmail\",\r\n          auth: { user: gmailAddress, pass: gmailAppPassword },\r\n        })\r\n\r\n        await transporter.verify()\r\n\r\n        return NextResponse.json({ success: true, message: \"Gmail SMTP connection verified.\" })\r\n      } catch (err: any) {\r\n        return NextResponse.json(\r\n          { error: err.message || \"Failed to verify Gmail SMTP connection\" },\r\n          { status: 400 },\r\n        )\r\n      }\r\n    }\r\n\r\n    // WhatsApp (UltraMsg) test: we verify that credentials are present and decrypt correctly.\r\n    if (!integration.ultramsg_instance_enc || !integration.ultramsg_token_enc) {\r\n      return NextResponse.json({ error: \"WhatsApp (UltraMsg) credentials not configured\" }, { status: 400 })\r\n    }\r\n\r\n    const instanceId = decryptWithKey(userKeyBase64, integration.ultramsg_instance_enc)\r\n    const token = decryptWithKey(userKeyBase64, integration.ultramsg_token_enc)\r\n\r\n    if (!instanceId || !token) {\r\n      return NextResponse.json({ error: \"Failed to decrypt UltraMsg credentials\" }, { status: 400 })\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message:\r\n        \"UltraMsg credentials are stored and decrypt correctly. Actual sending still depends on your UltraMsg instance status.\",\r\n    })\r\n  } catch (err: any) {\r\n    console.error(\"Integrations test error:\", err)\r\n    return NextResponse.json({ error: err.message ?? \"Unexpected error\" }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAMO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAQ,MAAM,QAAQ,IAAI;QAEhC,IAAI,CAAC,MAAM,QAAS,KAAK,IAAI,KAAK,WAAW,KAAK,IAAI,KAAK,YAAa;YACtE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqC,GAAG;gBAAE,QAAQ;YAAI;QAC1F;QAEA,MAAM,WAAW,MAAM,IAAA,2IAAY;QACnC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAE/B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,EAAE,MAAM,WAAW,EAAE,KAAK,EAAE,GAAG,MAAM,SACxC,IAAI,CAAC,qBACL,MAAM,CAAC,sGACP,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,MAAM;QAET,IAAI,SAAS,CAAC,aAAa;YACzB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA8B,GAAG;gBAAE,QAAQ;YAAI;QACnF;QAEA,MAAM,gBAAgB,IAAA,oIAAa,EAAC,YAAY,YAAY;QAE5D,IAAI,KAAK,IAAI,KAAK,SAAS;YACzB,IAAI,CAAC,YAAY,iBAAiB,IAAI,CAAC,YAAY,sBAAsB,EAAE;gBACzE,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAmC,GAAG;oBAAE,QAAQ;gBAAI;YACxF;YAEA,MAAM,eAAe,IAAA,qIAAc,EAAC,eAAe,YAAY,iBAAiB;YAChF,MAAM,mBAAmB,IAAA,qIAAc,EAAC,eAAe,YAAY,sBAAsB;YAEzF,IAAI;gBACF,MAAM,cAAc,4JAAU,CAAC,eAAe,CAAC;oBAC7C,SAAS;oBACT,MAAM;wBAAE,MAAM;wBAAc,MAAM;oBAAiB;gBACrD;gBAEA,MAAM,YAAY,MAAM;gBAExB,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,SAAS;oBAAM,SAAS;gBAAkC;YACvF,EAAE,OAAO,KAAU;gBACjB,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO,IAAI,OAAO,IAAI;gBAAyC,GACjE;oBAAE,QAAQ;gBAAI;YAElB;QACF;QAEA,0FAA0F;QAC1F,IAAI,CAAC,YAAY,qBAAqB,IAAI,CAAC,YAAY,kBAAkB,EAAE;YACzE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiD,GAAG;gBAAE,QAAQ;YAAI;QACtG;QAEA,MAAM,aAAa,IAAA,qIAAc,EAAC,eAAe,YAAY,qBAAqB;QAClF,MAAM,QAAQ,IAAA,qIAAc,EAAC,eAAe,YAAY,kBAAkB;QAE1E,IAAI,CAAC,cAAc,CAAC,OAAO;YACzB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyC,GAAG;gBAAE,QAAQ;YAAI;QAC9F;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SACE;QACJ;IACF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO,IAAI;QAAmB,GAAG;YAAE,QAAQ;QAAI;IACvF;AACF"}}]
}