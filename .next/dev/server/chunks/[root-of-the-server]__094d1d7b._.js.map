{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/LeadFlow/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // The \"setAll\" method was called from a Server Component.\n        }\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC5D;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/LeadFlow/lib/encryption.ts"],"sourcesContent":["import crypto from \"crypto\"\r\n\r\n// Master key must be a 32-byte key, provided as base64 in env CREDENTIALS_ENCRYPTION_KEY\r\nconst MASTER_KEY_ENV = process.env.CREDENTIALS_ENCRYPTION_KEY\r\n\r\nif (!MASTER_KEY_ENV) {\r\n  // We intentionally do not throw at import time to avoid breaking build if env is missing.\r\n  // The API routes that depend on this should validate and throw a clear error instead.\r\n  console.warn(\"CREDENTIALS_ENCRYPTION_KEY is not set. Encryption helpers will fail until it is configured.\")\r\n}\r\n\r\nfunction getMasterKey(): Buffer {\r\n  if (!MASTER_KEY_ENV) {\r\n    throw new Error(\"CREDENTIALS_ENCRYPTION_KEY is not configured\")\r\n  }\r\n  const key = Buffer.from(MASTER_KEY_ENV, \"base64\")\r\n  if (key.length !== 32) {\r\n    throw new Error(\"CREDENTIALS_ENCRYPTION_KEY must be a 32-byte key encoded in base64\")\r\n  }\r\n  return key\r\n}\r\n\r\nexport function generateRandomKey(): string {\r\n  // 32 random bytes, returned as base64\r\n  return crypto.randomBytes(32).toString(\"base64\")\r\n}\r\n\r\nexport interface EncryptedPayload {\r\n  ciphertext: string\r\n  iv: string\r\n  authTag: string\r\n}\r\n\r\nexport function encryptWithKey(keyBase64: string, plaintext: string): EncryptedPayload {\r\n  const key = Buffer.from(keyBase64, \"base64\")\r\n  if (key.length !== 32) {\r\n    throw new Error(\"Encryption key must be 32 bytes (base64-encoded)\")\r\n  }\r\n\r\n  const iv = crypto.randomBytes(12) // recommended IV size for GCM\r\n  const cipher = crypto.createCipheriv(\"aes-256-gcm\", key, iv)\r\n\r\n  const encrypted = Buffer.concat([cipher.update(plaintext, \"utf8\"), cipher.final()])\r\n  const authTag = cipher.getAuthTag()\r\n\r\n  return {\r\n    ciphertext: encrypted.toString(\"base64\"),\r\n    iv: iv.toString(\"base64\"),\r\n    authTag: authTag.toString(\"base64\"),\r\n  }\r\n}\r\n\r\nexport function decryptWithKey(keyBase64: string, payload: EncryptedPayload): string {\r\n  const key = Buffer.from(keyBase64, \"base64\")\r\n  if (key.length !== 32) {\r\n    throw new Error(\"Encryption key must be 32 bytes (base64-encoded)\")\r\n  }\r\n\r\n  const iv = Buffer.from(payload.iv, \"base64\")\r\n  const authTag = Buffer.from(payload.authTag, \"base64\")\r\n  const ciphertext = Buffer.from(payload.ciphertext, \"base64\")\r\n\r\n  const decipher = crypto.createDecipheriv(\"aes-256-gcm\", key, iv)\r\n  decipher.setAuthTag(authTag)\r\n\r\n  const decrypted = Buffer.concat([decipher.update(ciphertext), decipher.final()])\r\n  return decrypted.toString(\"utf8\")\r\n}\r\n\r\n// Wrap/unwrap per-user data key using master key\r\n\r\nexport function wrapUserKey(userKeyBase64: string): EncryptedPayload {\r\n  const masterKey = getMasterKey()\r\n  const iv = crypto.randomBytes(12)\r\n  const cipher = crypto.createCipheriv(\"aes-256-gcm\", masterKey, iv)\r\n\r\n  const encrypted = Buffer.concat([cipher.update(userKeyBase64, \"utf8\"), cipher.final()])\r\n  const authTag = cipher.getAuthTag()\r\n\r\n  return {\r\n    ciphertext: encrypted.toString(\"base64\"),\r\n    iv: iv.toString(\"base64\"),\r\n    authTag: authTag.toString(\"base64\"),\r\n  }\r\n}\r\n\r\nexport function unwrapUserKey(payload: EncryptedPayload): string {\r\n  const masterKey = getMasterKey()\r\n\r\n  const iv = Buffer.from(payload.iv, \"base64\")\r\n  const authTag = Buffer.from(payload.authTag, \"base64\")\r\n  const ciphertext = Buffer.from(payload.ciphertext, \"base64\")\r\n\r\n  const decipher = crypto.createDecipheriv(\"aes-256-gcm\", masterKey, iv)\r\n  decipher.setAuthTag(authTag)\r\n\r\n  const decrypted = Buffer.concat([decipher.update(ciphertext), decipher.final()])\r\n  return decrypted.toString(\"utf8\")\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;AAEA,yFAAyF;AACzF,MAAM,iBAAiB,QAAQ,GAAG,CAAC,0BAA0B;AAE7D,IAAI,CAAC,gBAAgB;IACnB,0FAA0F;IAC1F,sFAAsF;IACtF,QAAQ,IAAI,CAAC;AACf;AAEA,SAAS;IACP,IAAI,CAAC,gBAAgB;QACnB,MAAM,IAAI,MAAM;IAClB;IACA,MAAM,MAAM,OAAO,IAAI,CAAC,gBAAgB;IACxC,IAAI,IAAI,MAAM,KAAK,IAAI;QACrB,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEO,SAAS;IACd,sCAAsC;IACtC,OAAO,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;AACzC;AAQO,SAAS,eAAe,SAAiB,EAAE,SAAiB;IACjE,MAAM,MAAM,OAAO,IAAI,CAAC,WAAW;IACnC,IAAI,IAAI,MAAM,KAAK,IAAI;QACrB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC,IAAI,8BAA8B;;IAChE,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,eAAe,KAAK;IAEzD,MAAM,YAAY,OAAO,MAAM,CAAC;QAAC,OAAO,MAAM,CAAC,WAAW;QAAS,OAAO,KAAK;KAAG;IAClF,MAAM,UAAU,OAAO,UAAU;IAEjC,OAAO;QACL,YAAY,UAAU,QAAQ,CAAC;QAC/B,IAAI,GAAG,QAAQ,CAAC;QAChB,SAAS,QAAQ,QAAQ,CAAC;IAC5B;AACF;AAEO,SAAS,eAAe,SAAiB,EAAE,OAAyB;IACzE,MAAM,MAAM,OAAO,IAAI,CAAC,WAAW;IACnC,IAAI,IAAI,MAAM,KAAK,IAAI;QACrB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,KAAK,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE;IACnC,MAAM,UAAU,OAAO,IAAI,CAAC,QAAQ,OAAO,EAAE;IAC7C,MAAM,aAAa,OAAO,IAAI,CAAC,QAAQ,UAAU,EAAE;IAEnD,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,eAAe,KAAK;IAC7D,SAAS,UAAU,CAAC;IAEpB,MAAM,YAAY,OAAO,MAAM,CAAC;QAAC,SAAS,MAAM,CAAC;QAAa,SAAS,KAAK;KAAG;IAC/E,OAAO,UAAU,QAAQ,CAAC;AAC5B;AAIO,SAAS,YAAY,aAAqB;IAC/C,MAAM,YAAY;IAClB,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC;IAC9B,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,eAAe,WAAW;IAE/D,MAAM,YAAY,OAAO,MAAM,CAAC;QAAC,OAAO,MAAM,CAAC,eAAe;QAAS,OAAO,KAAK;KAAG;IACtF,MAAM,UAAU,OAAO,UAAU;IAEjC,OAAO;QACL,YAAY,UAAU,QAAQ,CAAC;QAC/B,IAAI,GAAG,QAAQ,CAAC;QAChB,SAAS,QAAQ,QAAQ,CAAC;IAC5B;AACF;AAEO,SAAS,cAAc,OAAyB;IACrD,MAAM,YAAY;IAElB,MAAM,KAAK,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE;IACnC,MAAM,UAAU,OAAO,IAAI,CAAC,QAAQ,OAAO,EAAE;IAC7C,MAAM,aAAa,OAAO,IAAI,CAAC,QAAQ,UAAU,EAAE;IAEnD,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,eAAe,WAAW;IACnE,SAAS,UAAU,CAAC;IAEpB,MAAM,YAAY,OAAO,MAAM,CAAC;QAAC,SAAS,MAAM,CAAC;QAAa,SAAS,KAAK;KAAG;IAC/E,OAAO,UAAU,QAAQ,CAAC;AAC5B"}},
    {"offset": {"line": 268, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/LeadFlow/app/api/campaigns/email/send/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport nodemailer from \"nodemailer\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { decryptWithKey, unwrapUserKey } from \"@/lib/encryption\"\r\n\r\ninterface SendCampaignBody {\r\n  campaignId: string\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { campaignId } = (await request.json()) as SendCampaignBody\r\n\r\n    if (!campaignId) {\r\n      return NextResponse.json({ error: \"campaignId is required\" }, { status: 400 })\r\n    }\r\n\r\n    const supabase = await createClient()\r\n    const {\r\n      data: { user },\r\n    } = await supabase.auth.getUser()\r\n\r\n    if (!user) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n    }\r\n\r\n    const { data: campaign, error: campaignError } = await supabase\r\n      .from(\"campaigns\")\r\n      .select(\"*\")\r\n      .eq(\"id\", campaignId)\r\n      .eq(\"user_id\", user.id)\r\n      .eq(\"type\", \"email\")\r\n      .single()\r\n\r\n    if (campaignError || !campaign) {\r\n      return NextResponse.json({ error: \"Campaign not found\" }, { status: 404 })\r\n    }\r\n\r\n    const { data: recipientsData, error: recipientsError } = await supabase\r\n      .from(\"campaign_recipients\")\r\n      .select(\"*, leads(*)\")\r\n      .eq(\"campaign_id\", campaignId)\r\n\r\n    if (recipientsError) {\r\n      console.error(\"Error fetching recipients:\", recipientsError)\r\n      return NextResponse.json({ error: \"Failed to load recipients\" }, { status: 500 })\r\n    }\r\n\r\n    const recipients = (recipientsData || []).filter((r: any) => r.leads && r.leads.email)\r\n\r\n    if (recipients.length === 0) {\r\n      return NextResponse.json({ error: \"No recipients with email\" }, { status: 400 })\r\n    }\r\n\r\n    const { data: integration, error: integrationError } = await supabase\r\n      .from(\"user_integrations\")\r\n      .select(\"user_key_enc, gmail_address_enc, gmail_app_password_enc\")\r\n      .eq(\"user_id\", user.id)\r\n      .single()\r\n\r\n    if (integrationError || !integration) {\r\n      return NextResponse.json({ error: \"Email integration not configured\" }, { status: 400 })\r\n    }\r\n\r\n    const userKeyBase64 = unwrapUserKey(integration.user_key_enc)\r\n    const gmailAddress = decryptWithKey(userKeyBase64, integration.gmail_address_enc)\r\n    const gmailAppPassword = decryptWithKey(userKeyBase64, integration.gmail_app_password_enc)\r\n\r\n    const transporter = nodemailer.createTransport({\r\n      service: \"gmail\",\r\n      auth: {\r\n        user: gmailAddress,\r\n        pass: gmailAppPassword,\r\n      },\r\n    })\r\n\r\n    let sent = 0\r\n    let failed = 0\r\n    const errors: { email: string; error: string }[] = []\r\n\r\n    for (const r of recipients) {\r\n      const lead = r.leads\r\n      const recipientEmail = lead.email as string\r\n      const recipientName = lead.name || recipientEmail\r\n\r\n      const subject = (campaign.subject || \"\").replace(/{name}/g, recipientName).replace(/{business_name}/g, recipientName)\r\n\r\n      const htmlContent = (campaign.content || \"\").replace(/{name}/g, recipientName).replace(/{business_name}/g, recipientName)\r\n\r\n      try {\r\n        await transporter.sendMail({\r\n          from: gmailAddress,\r\n          to: recipientEmail,\r\n          subject,\r\n          html: htmlContent,\r\n        })\r\n        sent++\r\n      } catch (err: any) {\r\n        failed++\r\n        errors.push({ email: recipientEmail, error: err.message || \"Failed to send\" })\r\n      }\r\n\r\n      await new Promise((resolve) => setTimeout(resolve, 1000 + Math.random() * 2000))\r\n    }\r\n\r\n    const now = new Date().toISOString()\r\n\r\n    await supabase\r\n      .from(\"campaigns\")\r\n      .update({ status: \"sent\", sent_at: now, updated_at: now })\r\n      .eq(\"id\", campaignId)\r\n      .eq(\"user_id\", user.id)\r\n\r\n    await supabase\r\n      .from(\"campaign_recipients\")\r\n      .update({ status: \"sent\", sent_at: now })\r\n      .eq(\"campaign_id\", campaignId)\r\n\r\n    const { data: profile } = await supabase.from(\"profiles\").select(\"email_credits\").eq(\"id\", user.id).single()\r\n\r\n    if (profile) {\r\n      const remaining = Math.max(0, (profile.email_credits || 0) - sent)\r\n      await supabase\r\n        .from(\"profiles\")\r\n        .update({ email_credits: remaining, updated_at: now })\r\n        .eq(\"id\", user.id)\r\n    }\r\n\r\n    return NextResponse.json({ success: true, sent, failed, errors })\r\n  } catch (err: any) {\r\n    console.error(\"Email campaign send error:\", err)\r\n    return NextResponse.json({ error: err.message ?? \"Unexpected error\" }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}